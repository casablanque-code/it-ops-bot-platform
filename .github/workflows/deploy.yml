name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Build & Push Docker image (GHCR)"]  # запуск после сборки
    types: [completed]
  workflow_dispatch: {}                               # вручную

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    # запускаем ТОЛЬКО если пришли из workflow_run и он success,
    # либо если запуск вручную (workflow_dispatch)
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (опционально)
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy on VPS
        env:
          SSH_HOST: ${{ secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.VPS_USER }}
          SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          APP_DIR: /root/it-ops-bot
        run: |
          set -euo pipefail
          : "${SSH_HOST:?VPS_HOST secret is required}"
          : "${SSH_USER:?VPS_USER secret is required}"
          PORT="${SSH_PORT:-22}"

          # Проверка соединения
          ssh -o StrictHostKeyChecking=no -p "$PORT" "$SSH_USER@$SSH_HOST" "echo 'SSH OK on ' \$(hostname) '; user=' \$(whoami)"

          # Деплой
          ssh -o StrictHostKeyChecking=no -p "$PORT" "$SSH_USER@$SSH_HOST" bash -lc "
            set -euo pipefail

            cd '$APP_DIR' || { echo 'APP_DIR $APP_DIR not found'; exit 1; }
            test -f docker-compose.prod.yml || { echo 'docker-compose.prod.yml not found in $APP_DIR'; exit 1; }

            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d

            docker image prune -f

            echo '--- compose ps ---'
            docker compose -f docker-compose.prod.yml ps
          "
